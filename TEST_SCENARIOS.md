# テストシナリオ

サブスクリプション機能のテスト手順書

## 前提条件

- Astro開発サーバーが起動していること (`npm run dev`)
- Firebase Authenticationが正しく設定されていること
- Stripe APIキーが環境変数に設定されていること
- テスト用のNotionページに divider ブロックが含まれていること

## 1. 認証機能のテスト

### 1.1 Googleログイン

1. ブラウザで `http://localhost:4321/login` にアクセス
2. 「Googleでログイン」ボタンをクリック
3. Googleアカウントでログイン
4. トップページにリダイレクトされることを確認
5. ヘッダーのユーザーアイコンが表示されることを確認

**期待結果:**

- ログイン成功
- トップページへリダイレクト
- Tobiratoryアカウントが自動作成される

### 1.2 Appleログイン

1. ブラウザで `http://localhost:4321/login` にアクセス
2. 「Appleでログイン」ボタンをクリック
3. Apple IDでログイン
4. トップページにリダイレクトされることを確認
5. ヘッダーのユーザーアイコンが表示されることを確認

**期待結果:**

- ログイン成功
- トップページへリダイレクト
- Tobiratoryアカウントが自動作成される

### 1.3 メールログイン（Magic Link）

1. ブラウザで `http://localhost:4321/login` にアクセス
2. メールアドレスを入力
3. 「メールでログイン / 新規登録」ボタンをクリック
4. 「ログインリンクを送信しました」メッセージが表示されることを確認
5. メールを確認し、ログインリンクをクリック
6. トップページにリダイレクトされることを確認

**期待結果:**

- メール送信成功メッセージが表示される
- メール内のリンクからログインできる
- トップページへリダイレクト

### 1.4 ログアウト

1. ログイン状態で `/mypage` にアクセス
2. 「ログアウト」ボタンをクリック
3. トップページにリダイレクトされることを確認
4. ヘッダーのユーザーアイコンが消えることを確認

**期待結果:**

- ログアウト成功
- トップページへリダイレクト
- ログイン状態が解除される

## 2. マイページのテスト

### 2.1 未ログイン時のアクセス

1. ログアウト状態で `/mypage` にアクセス
2. 「ログインしてください」メッセージが表示されることを確認
3. 「ログインページへ」リンクをクリック
4. ログインページにリダイレクトされることを確認

**期待結果:**

- ログインを促すメッセージが表示される
- ログインページへのリンクが機能する

### 2.2 ログイン時のアクセス

1. ログイン状態で `/mypage` にアクセス
2. メールアドレスが表示されることを確認
3. 登録日時が表示されることを確認

**期待結果:**

- ユーザー情報が正しく表示される

## 3. プレミアムコンテンツのテスト

### 3.1 dividerブロックの検出

1. Notionで新しい記事を作成
2. 任意のコンテンツを入力
3. dividerブロックを挿入
4. divider以降にコンテンツを入力
5. ブログでその記事を表示
6. divider以前のコンテンツが表示されることを確認
7. divider以降のコンテンツがペイウォールで隠されていることを確認

**期待結果:**

- divider以前: 無料コンテンツとして表示
- divider以降: ペイウォールで隠される

### 3.2 ペイウォール表示（未ログイン）

1. ログアウト状態で有料コンテンツを含む記事にアクセス
2. 無料コンテンツ部分が表示されることを確認
3. ペイウォールが表示されることを確認
4. 「プランを見る」「ログイン」ボタンが表示されることを確認

**期待結果:**

- 無料部分のみ表示される
- ペイウォールが表示される
- CTAボタンが機能する

### 3.3 ペイウォール表示（無料会員）

1. ログイン状態（無料会員）で有料コンテンツを含む記事にアクセス
2. 無料コンテンツ部分が表示されることを確認
3. ペイウォールが表示されることを確認
4. 有料コンテンツが隠されていることを確認

**期待結果:**

- 無料部分のみ表示される
- ペイウォールが表示される
- 有料コンテンツは表示されない

### 3.4 dividerなし記事の表示

1. dividerブロックを含まない記事にアクセス
2. 全てのコンテンツが表示されることを確認
3. ペイウォールが表示されないことを確認

**期待結果:**

- 全コンテンツが無料で表示される
- ペイウォールは表示されない

## 4. サブスクリプション機能のテスト

### 4.1 プラン選択ページの表示

1. `/subscription` にアクセス
2. 3つのプランカード（ベーシック、スタンダード、プレミアム）が表示されることを確認
3. 各プランの価格と機能が表示されることを確認

**期待結果:**

- 3つのプランが正しく表示される
- 価格と機能説明が表示される

### 4.2 未ログイン時のプラン加入試行

1. ログアウト状態で `/subscription` にアクセス
2. 「加入する」ボタンが無効化されていることを確認
3. 「ログインしてください」メッセージが表示されることを確認

**期待結果:**

- ボタンが無効化される
- ログインを促すメッセージが表示される

### 4.3 Stripe Checkoutセッション作成（ログイン時）

**注意: この機能は現在、Stripe Price IDの設定が完了するまでテストできません**

1. ログイン状態で `/subscription` にアクセス
2. いずれかのプランの「このプランに加入する」ボタンをクリック
3. ボタンが「処理中...」に変わることを確認
4. Stripe Checkoutページにリダイレクトされることを確認

**期待結果:**

- ボタンが「処理中...」に変わる
- Stripe Checkoutページへリダイレクト

**現在のブロッカー:**

- Stripe Price IDが環境変数に正しく設定されていない
- テストモードでPrice IDが存在しない

### 4.4 決済成功時の処理

**注意: この機能は現在、DB実装とWebhook実装が完了するまでテストできません**

1. Stripe Checkoutで決済を完了
2. `/success?session_id=xxx` にリダイレクトされることを確認
3. 成功メッセージが表示されることを確認
4. マイページへのリンクが表示されることを確認

**期待結果:**

- 成功ページへリダイレクト
- 成功メッセージが表示される

### 4.5 決済キャンセル時の処理

1. Stripe Checkoutで「戻る」をクリック
2. `/cancel` にリダイレクトされることを確認
3. キャンセルメッセージが表示されることを確認
4. プラン選択ページへのリンクが表示されることを確認

**期待結果:**

- キャンセルページへリダイレクト
- キャンセルメッセージが表示される

## 5. エラーハンドリングのテスト

### 5.1 APIエラー時の表示

1. ネットワークを無効化
2. ログインを試行
3. エラーメッセージが日本語で表示されることを確認

**期待結果:**

- 日本語のエラーメッセージが表示される
- ユーザーが再試行できる

### 5.2 無効なPrice ID時のエラー

1. `.env` で無効なPrice IDを設定
2. プランへの加入を試行
3. エラーメッセージが表示されることを確認

**期待結果:**

- エラーメッセージが表示される
- ボタンが再度有効化される

## 6. レスポンシブデザインのテスト

### 6.1 モバイル表示

1. Chrome DevToolsでモバイルビューに切り替え
2. 各ページ（トップ、ログイン、サブスクリプション、マイページ）を表示
3. レイアウトが崩れていないことを確認
4. ボタンがタップ可能なサイズであることを確認

**期待結果:**

- モバイルで正しく表示される
- UIが使いやすい

### 6.2 タブレット表示

1. Chrome DevToolsでタブレットビューに切り替え
2. 各ページを表示
3. レイアウトが適切に調整されることを確認

**期待結果:**

- タブレットで正しく表示される

## 7. セキュリティのテスト

### 7.1 認証状態の確認

1. ログイン後、Firebase認証トークンがローカルストレージに保存されることを確認
2. ログアウト後、トークンが削除されることを確認

**期待結果:**

- トークンが適切に管理される

### 7.2 APIエンドポイントの保護

1. 未ログイン状態で直接 `/api/create-checkout-session` にPOSTリクエストを送信
2. エラーが返されることを確認

**期待結果:**

- 未認証のリクエストが拒否される

## 8. ブラウザ互換性テスト

### 8.1 主要ブラウザでの動作確認

以下のブラウザで主要機能をテスト:

- Chrome (最新版)
- Safari (最新版)
- Firefox (最新版)
- Edge (最新版)

**期待結果:**

- すべてのブラウザで正常に動作する

## 9. パフォーマンステスト

### 9.1 ページ読み込み速度

1. Lighthouseで各ページのパフォーマンスを測定
2. パフォーマンススコアが80以上であることを確認

**期待結果:**

- ページが3秒以内に読み込まれる
- Lighthouseスコア80以上

## 注意事項

### 現在テスト不可能な機能

以下の機能はDB実装とStripe設定が完了するまでテストできません:

1. **実際のサブスクリプション作成**
   - Stripe Price IDが未設定
   - tobiratory-web APIが未実装

2. **サブスクリプション状態の確認**
   - DBが未実装
   - `/blog/subscription-status` APIが未実装

3. **Stripe Webhook処理**
   - Webhook エンドポイントが未実装
   - DB更新処理が未実装

4. **有料会員のプレミアムコンテンツアクセス**
   - サブスクリプション状態の確認APIが未実装

### テスト前の準備

1. `.env` ファイルの設定

   ```
   PUBLIC_FIREBASE_API_KEY=xxx
   PUBLIC_FIREBASE_AUTH_DOMAIN=xxx
   PUBLIC_FIREBASE_PROJECT_ID=xxx
   PUBLIC_STRIPE_PUBLISHABLE_KEY=xxx
   STRIPE_SECRET_KEY=xxx
   PUBLIC_STRIPE_PRICE_ID_BASIC=price_xxx  # 未設定
   PUBLIC_STRIPE_PRICE_ID_STANDARD=price_xxx  # 未設定
   PUBLIC_STRIPE_PRICE_ID_PREMIUM=price_xxx  # 未設定
   ```

2. Notionデータベースの準備
   - テスト用の記事を作成
   - dividerブロックを含む記事を用意
   - dividerなしの記事も用意

3. Firebase Authenticationの設定
   - Google認証を有効化
   - Apple認証を有効化
   - メール認証（Magic Link）を有効化

## テスト完了チェックリスト

- [ ] 認証機能（Google/Apple/Email）
- [ ] ログアウト機能
- [ ] マイページ表示（ログイン/未ログイン）
- [ ] プレミアムコンテンツの分割表示
- [ ] ペイウォールの表示
- [ ] プラン選択ページの表示
- [ ] エラーメッセージの日本語表示
- [ ] レスポンシブデザイン（Mobile/Tablet/Desktop）
- [ ] ブラウザ互換性（Chrome/Safari/Firefox/Edge）
- [ ] パフォーマンス（Lighthouse 80+）

## 既知の問題

1. Stripe Price IDが未設定のため、実際の決済フローはテストできない
2. DB未実装のため、サブスクリプション状態の永続化と確認ができない
3. tobiratory-web APIが未実装のため、バックエンド処理がテストできない
